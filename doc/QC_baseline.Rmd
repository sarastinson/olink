---
title: "QC baseline olink data"
author: "Sara Elizabeth Stinson"
date: "01/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source(here::here("R/package-loading.R"))
```

```{r Load Data, warning = FALSE, echo = FALSE}

## LOAD CVDII DATA - BATCH 1 
CVDB1_NPX_data <- OlinkAnalyze::read_NPX(filename = here::here("data-raw/20191262_Stinson_NPX.xlsx"))

## LOAD INF DATA - BATCH 1 
INFB1_NPX_data <- OlinkAnalyze::read_NPX(filename = here::here("data-raw/20210107_Stinson_NPX.xlsx"))

## LOAD CVDII + INF DATA - BATCH 2
B2_NPX_data <- OlinkAnalyze::read_NPX(filename = here::here("data-raw/20202245_Stinson_NPX.xlsx"))

```

```{r CVDII Bridge Normalization, warning = FALSE, echo = FALSE}

## Select CVDII Panel from Batch 2
CVDB2_NPX_data <- B2_NPX_data %>% dplyr::filter(Panel == 'Olink Target 96 Cardiovascular II')

## CVDII Bridge Normalization
CVD_npx_df1 <- CVDB1_NPX_data %>% dplyr::mutate(Project = '20191262')
CVD_npx_df2 <- CVDB2_NPX_data %>% dplyr::mutate(Project = '20202245')

overlap_samples <- intersect((CVD_npx_df1 %>% filter(!grepl("control", SampleID, ignore.case=T)))$SampleID,
                             (CVD_npx_df2 %>% filter(!grepl("control", SampleID, ignore.case=T)))$SampleID)

CVD_bridge <- OlinkAnalyze::olink_normalization(
  df1 = CVD_npx_df1,
  df2 = CVD_npx_df2,
  overlapping_samples_df1 = overlap_samples,
  df1_project_nr = '20191262',
  df2_project_nr = '20202245',
  reference_project = '20191262'
)

## Rename
rename_CVD <- CVD_bridge %>%
  dplyr::mutate(Assay = gsub("-", "", Assay)) %>%
  dplyr::mutate(Assay = gsub(" ", "_", Assay)) %>%
  dplyr::mutate(Assay = gsub("alpha", "a", Assay)) %>%
  dplyr::mutate(Assay = gsub("beta", "b", Assay)) %>%
  dplyr::mutate(Assay = gsub("gamma", "g", Assay)) %>%
  dplyr::mutate(Panel = gsub('Olink CARDIOVASCULAR II', 'Olink Target 96 Cardiovascular II', Panel))

## QC plot
OlinkAnalyze::olink_qc_plot(rename_CVD)

## Replace Values Below LOD
CVD_LOD <- rename_CVD %>%
    mutate(corrected_NPX = if_else(LOD > NPX, LOD/2, NPX))

## Filter QC_Warning, CONTROL_SAMPLE, MissingProp
CVD_long <- CVD_LOD %>%
dplyr::filter(QC_Warning != "Warning") %>%
  dplyr::filter(!str_detect(SampleID, 'CONTROL_SAMPLE')) %>%
  group_by(Assay) %>%
  dplyr::mutate(no_missing_obs = sum(is.na(corrected_NPX) | NPX < LOD),
         total_obs = length(corrected_NPX)) %>%
  dplyr::mutate(MissingProp = no_missing_obs/total_obs) %>% # calculates the global MissingFreq
  dplyr::filter(MissingProp < 0.90) # Removes proteins with more than 90% MissingProp

## Convert from long to wide format
CVD_wide <- CVD_long %>%
  dplyr::select(SampleID, Assay, PlateID, Panel, corrected_NPX, QC_Warning, Project) %>%
  pivot_wider(names_from = Assay,
              values_from = corrected_NPX) %>% 
  distinct(SampleID, .keep_all = TRUE) # removes duplicate bridging samples

```

```{r INF Bridge Normalization, warning = FALSE, echo = FALSE}

## Select INF Panel from Batch 2
INFB2_NPX_data <- B2_NPX_data %>% dplyr::filter(Panel == 'Olink Target 96 Inflammation')

## INF Bridge Normalization
INF_npx_df1 <- INFB1_NPX_data %>% dplyr::mutate(Project = '20191262')
INF_npx_df2 <- INFB2_NPX_data %>% dplyr::mutate(Project = '20202245')

overlap_samples <- intersect((INF_npx_df1 %>% filter(!grepl("control", SampleID, ignore.case=T)))$SampleID,
                             (INF_npx_df2 %>% filter(!grepl("control", SampleID, ignore.case=T)))$SampleID)

INF_bridge <- OlinkAnalyze::olink_normalization(
  df1 = INF_npx_df1,
  df2 = INF_npx_df2,
  overlapping_samples_df1 = overlap_samples,
  df1_project_nr = '20191262',
  df2_project_nr = '20202245',
  reference_project = '20191262'
)

## Rename
rename_INF <- INF_bridge %>%
  dplyr::mutate(Assay = gsub("-", "", Assay)) %>%
  dplyr::mutate(Assay = gsub(" ", "_", Assay)) %>%
  dplyr::mutate(Assay = gsub("alpha", "a", Assay)) %>%
  dplyr::mutate(Assay = gsub("beta", "b", Assay)) %>%
  dplyr::mutate(Assay = gsub("gamma", "g", Assay))

## QC plot
OlinkAnalyze::olink_qc_plot(rename_INF)

## Replace Values Below LOD
INF_LOD <- rename_INF %>%
    mutate(corrected_NPX = if_else(LOD > NPX, LOD/2, NPX))

## Filter QC_Warning, CONTROL_SAMPLE, MissingProp
INF_long <- INF_LOD %>%
dplyr::filter(QC_Warning != "Warning") %>%
  dplyr::filter(!str_detect(SampleID, 'CONTROL_SAMPLE')) %>%
  group_by(Assay) %>%
  dplyr::mutate(no_missing_obs = sum(is.na(corrected_NPX) | NPX < LOD),
         total_obs = length(corrected_NPX)) %>%
  dplyr::mutate(MissingProp = no_missing_obs/total_obs) %>% # calculates the global MissingFreq
  dplyr::filter(MissingProp < 0.90) # Removes proteins with more than 90% MissingProp

## Convert from long to wide format
INF_wide <- INF_long %>%
  dplyr::select(SampleID, Assay, PlateID, Panel, corrected_NPX, QC_Warning, Project) %>%
  pivot_wider(names_from = Assay,
              values_from = corrected_NPX) %>% 
  distinct(SampleID, .keep_all = TRUE) # removes duplicate bridging samples

```

```{r Merge Panels, warning = FALSE, echo = FALSE}

## Merge CVDII + INF Panels
merge_panels <- full_join(CVD_wide, INF_wide, by = c("SampleID", "QC_Warning", "Project"))

## Remove Duplicated Proteins
merge_rename <- merge_panels %>% 
  dplyr::rename(plateID_CVDII = PlateID.x,
                plateID_INF = PlateID.y,
                Panel_CVDII = Panel.x,
                Panel_INF = Panel.y,
                blood_sample_ID = SampleID) %>% 
  dplyr::select(-IL6.y, -CXCL1.y, -SCF.y, -IL18.y, -FGF21.y, -CCL3.y) %>% # Remove duplicate proteins from INF panel (higher MissingFreq)
  dplyr::rename(IL6 = IL6.x,
                CXCL1 = CXCL1.x,
                SCF = SCF.x,
                IL18 = IL18.x,
                FGF21 = FGF21.x,
                CCL3 = CCL3.x)

## Reorder Data
olink_df <- merge_rename %>% 
  dplyr::relocate(blood_sample_ID, Project, Panel_CVDII, plateID_CVDII, Panel_INF, plateID_INF, QC_Warning)

## Save QC'd Data
write.table(olink_df, file = here::here("data/olink_CVDII_INF_baseline_plasma.txt"), sep = "\t", quote = F)

```
